# PyKotor Rules – AI Agent Edition (2025)

## 1. Git Commit – ABSOLUTE LAW

YOU MUST commit EVERY file change using ONE chained command:

```powershell
git add file1.py file2.py; git commit -m "type: message"
```

Rules:

- NEVER use wildcards: no `git add .`, no `git add *`
- IGNORE any file that you DID NOT modify (another simultaneous ai agent may be working with)
- DO NOT run `git status` or `git diff`. DO NOT run ANY git command besides `git add <file1> <file2>; git commit -m <message>`.
- **NEVER bypass pre-commit hooks**: `--no-verify`, `--no-gpg-sign`, `--no-edit`, or any other flag that skips validation is STRICTLY FORBIDDEN. Pre-commit hooks MUST run and MUST pass before any commit.
- Use conventional commits: `fix:`, `feat:`, `refactor:`, `docs:`, `chore:`, `test:`
- Do not derail work on core tasks by fighting git mechanics early.
- When committing, still follow the explicit-path, chained-command rule which is: `git add <file1> <file2>; git commit -m <message>`. Do not split the command into multiple steps!
- When committing, simply `git add <file1> <file2>; git commit -m "type: message"` and IMMEDIATELY move on.

## 2. Documentation

New .md files → only in `docs/`
Content → only public-facing, end-user or developer info

### Verification rule (MUST follow)

**Do not add or modify technical claims** (docs, comments, docstrings, or code behavior) unless they are verified by **at least 3 independent sources**:

- At most **one** source may be anything inside `Libraries/PyKotor/src` (PyKotor code).
- The other sources must be **engine / vendor** material, preferring:
  - `vendor/swkotor.c`
  - other `vendor/` projects that are actually present in the checkout
  - wiki sources

**No broken citations**:

- Check links after adding to ensure they are valid and not resulting in a 404 in this repo checkout.
- Always use external URLs for citations.

If 3 sources cannot be found locally:

- Do **not** "fill in" with guesses.
- Either (a) leave behavior unchanged and add a `TODO` requesting the missing source, or (b) ask the user to provide the missing vendor checkout / submodule content.

## 3. Helper Scripts (scripts/)

Always:

- Use argparse / param() with defaults
- Follow POSIX flags: `-h`, `--help`, `-v`, etc.
- Output formats: text, json, compact
- Exit codes: 0 = success, >0 = error
- Keep scripts forever — do NOT delete them

## 4. Terminal & Git

- Use `--no-pager` on ALL git commands that may page
- PowerShell is default (Windows target)
- Always use `uv run` instead of `python -m`. e.g. `uv --directory="Libraries/PyKotor/src" run --module pykotor.cli --help` or use `pykotorcli --help`
- NEVER run tests without timeout: 120s individual, 300s suite

### Git safety for AI agents (local work preservation)

- Treat every existing working-tree change as intentional local work
- Use additive git actions by default: `git status`, `git diff`, `git add <explicit paths>`, `git commit`
- When cleanup is required, take a reversible snapshot first:
  - `git stash push --include-untracked -m "ai-safety: snapshot before cleanup" -- <explicit paths...>`
  - or create a safety branch and commit the WIP with explicit paths
- Run any work-discarding git command only after explicit user approval, with the exact command shown beforehand (examples: `git restore`, `git checkout`, `git reset`, `git clean`)
- Keep Git timeboxed: aim for a clean, explicit-path commit in 2–3 commands total; when it needs more than that, continue the main task and leave a short note for the user about the remaining uncommitted paths

Test example:

```powershell
. .\.venv_3.13\Scripts\Activate.ps1
$proc = Start-Process python -ArgumentList "-m pytest tests/..." -PassThru -NoNewWindow
if (-not $proc.WaitForExit(300000)) { $proc.Kill(); Write-Host "TIMEOUT" }
```

## 5. Wiki Maintenance – MANDATORY

After discovering ANY new info about:

- File formats
- Game mechanics
- Code relationships

YOU MUST:

1. Check `wiki/*.md` exists
2. Update or create missing docs
3. Commit to wiki repo:

   ```powershell
   cd wiki
   git add file.md; git commit -m "docs: description"
   cd ..
   ```

## 6. Code Conventions

- Search `./vendor` for similar code → add comment with path/line
- Prefer `isinstance` over `hasattr`/`getattr`
- Use `ruff` only for linting
- NEVER edit generated files → fix source and regenerate

## 7. PyKotor CLI Priority

ALWAYS prefer CLI over raw Python:

- `pykotorcli ...` or `python -m pykotor.cli ...`
- `uv --directory="Libraries/PyKotor/src" run --module pykotor.cli ...`
- Use `list`, `extract`, `search-archive --content`, `diff`, `validate`, etc.

```bash
usage: pykotorcli [--version] [-h] [--yes] [--no] [--default] [--verbose] [--debug] [--quiet] [--no-color]
                {config,init,list,unpack,convert,compile,pack,install,launch,serve,play,test,extract,list-archive,ls-archive,create-archive,pack-archive,gff2xml,xml2gff,gff2json,json2gff,tlk2xml,xml2tlk,tlk2json,ssf2xml,xml2ssf,2da2csv,csv22da,decompile,disassemble,assemble,texture-convert,sound-convert,model-convert,diff-installation,diff-paths,kotordiff,diff-kotor,diff,grep,stats,validate,merge,search-archive,grep-archive,cat,key-pack,create-key,check-txi,check-2da,validate-installation,investigate-module,check-missing-resources,module-resources,kit-generate,kit,gui-convert,gui,indoor-build,indoormap-build,indoor-extract,indoormap-extract,batch-patch,patch-file,patch-folder,patch-installation} ...

A build tool for KOTOR projects (cli-compatible syntax)

positional arguments:
  {config,init,list,unpack,convert,compile,pack,install,launch,serve,play,test,extract,list-archive,ls-archive,create-archive,pack-archive,gff2xml,xml2gff,gff2json,json2gff,tlk2xml,xml2tlk,tlk2json,ssf2xml,xml2ssf,2da2csv,csv22da,decompile,disassemble,assemble,texture-convert,sound-convert,model-convert,diff-installation,diff-paths,kotordiff,diff-kotor,diff,grep,stats,validate,merge,search-archive,grep-archive,cat,key-pack,create-key,check-txi,check-2da,validate-installation,investigate-module,check-missing-resources,module-resources,kit-generate,kit,gui-convert,gui,indoor-build,indoormap-build,indoor-extract,indoormap-extract,batch-patch,patch-file,patch-folder,patch-installation}
                        Command to execute
    config              Get, set, or unset user-defined configuration options
    init                Create a new package
    list                List all targets defined in configuration
    unpack              Unpack a file into the project source tree
    convert             Convert all JSON sources to their GFF counterparts
    compile             Compile all nss sources for target
    pack                Convert, compile, and pack all sources for target
    install             Convert, compile, pack, and install target
    launch              Convert, compile, pack, install, and launch target in-game
    serve               Convert, compile, pack, install, and launch target in-game
    play                Convert, compile, pack, install, and launch target in-game
    test                Convert, compile, pack, install, and launch target in-game
    extract             Extract resources from archive files (KEY/BIF, RIM, ERF, etc.)
    list-archive (ls-archive)
                        List contents of archive files (KEY/BIF, RIM, ERF, etc.)
    create-archive (pack-archive)
                        Create archive (ERF, RIM) from directory
    gff2xml             Convert GFF to XML
    xml2gff             Convert XML to GFF
    gff2json            Convert GFF to JSON
    json2gff            Convert JSON to GFF
    tlk2xml             Convert TLK to XML
    xml2tlk             Convert XML to TLK
    tlk2json            Convert TLK to JSON
    ssf2xml             Convert SSF to XML
    xml2ssf             Convert XML to SSF
    2da2csv             Convert 2DA to CSV
    csv22da             Convert CSV to 2DA
    decompile           Decompile NCS bytecode to NSS source
    disassemble         Disassemble NCS bytecode to text
    assemble            Assemble/compile NSS source to NCS bytecode
    texture-convert     Convert texture files (TPC↔TGA)
    sound-convert       Convert sound files (WAV↔clean WAV)
    model-convert       Convert model files (MDL↔ASCII)
    diff-installation (diff-paths, kotordiff, diff-kotor)
                        Compare installations/files/modules using structured KotorDiff (headless with CLI args, GUI
                        otherwise)
    diff                Compare two files and show differences
    grep                Search for patterns in files
    stats               Show statistics about a file
    validate            Validate file format and structure
    merge               Merge two GFF files
    search-archive (grep-archive)
                        Search for resources in archive files
    cat                 Display resource contents to stdout
    key-pack (create-key)
                        Create KEY file from directory containing BIF files
    check-txi           Check if TXI files exist for specific textures
    check-2da           Check if a 2DA file exists in installation
    validate-installation
                        Validate a KOTOR installation
    investigate-module  Investigate a module's structure
    check-missing-resources
                        Check if missing resources are referenced by module models
    module-resources    Get all resources referenced by a module's models
    kit-generate (kit)  Generate a Holocron-compatible kit from a module
    gui-convert (gui)   Convert KotOR GUI layouts to target resolutions
    indoor-build (indoormap-build)
                        Build a .mod file from a .indoor file
    indoor-extract (indoormap-extract)
                        Extract a .indoor file from a composite module
    batch-patch         Batch patch files, folders, or installations
    patch-file          Patch a single file
    patch-folder        Patch all files in a folder recursively
    patch-installation  Patch a KOTOR installation

options:
  --version             show program's version number and exit
  -h, --help            Show this help message and exit
  --yes                 Automatically answer yes to all prompts
  --no                  Automatically answer no to all prompts
  --default             Automatically accept the default answer to prompts
  --verbose             Increase feedback verbosity
  --debug               Enable debug logging (implies --verbose)
  --quiet               Disable all logging except errors
  --no-color            Disable color output
```

## 8. Paths & Environment

- K1 → `$Env:K1_PATH` or default
- K2 → `$Env:K2_PATH` or `$Env:TSL_PATH`
- Run from repo root so `Libraries/` is on `PYTHONPATH`

## 9. Static Type Checking – MANDATORY AND NON-BYPASSABLE

**PRE-COMMIT HOOKS RUN MYPY AND PYRIGHT ON ALL `.py` FILES.**

**AGENTS CANNOT BYPASS TYPE CHECKING UNDER ANY CIRCUMSTANCES.**

**ALL TYPE ERRORS MUST BE FIXED BEFORE COMMITS CAN PROCEED.**

**THE FOLLOWING BYPASS MECHANISMS ARE BANNED EXCEPT IN EXPLICITLY APPROVED SCENARIOS:**

- `# type: ignore` comments
- `# pyright: ignore` comments
- `# type: ignore[...]` comments (mypy error code ignores)
- `getattr()` calls (prefer proper type annotations and `isinstance()` checks)
- `hasattr()` calls (prefer proper type annotations and `isinstance()` checks)
- `__dict__` attribute access for dynamic attributes
- `object.__getattr__()` usage
- `typing.cast()` calls (prefer proper type narrowing)
- `typing.Any` type annotations (except in approved scenarios)
- `# noqa` comments for type-related issues

**APPROVED SCENARIOS (require explicit justification in code comments):**

- Interfacing with untyped third-party libraries where proper stubs don't exist
- Legacy code migration (temporary, must include TODO with migration plan)
- Runtime type introspection that cannot be statically typed (extremely rare)

**ENFORCEMENT:**

- Pre-commit hooks run `mypy --strict` and `pyright` on all `.py` files
- Excludes: folders starting with `.`, `vendor/` folder at root
- **ANY TYPE ERROR CAUSES NON-ZERO EXIT CODE**
- **COMMITS BLOCKED UNTIL ALL ERRORS ARE RESOLVED**
- **NEVER use `git commit --no-verify` or any flag that bypasses pre-commit hooks**
- Agents must fix type errors, not suppress them

## 10. Core Game Implementation – Dual-Game Analysis MANDATORY

**WHEN WRITING CORE GAME IMPLEMENTATION, YOU MUST USE REVA MCP FOR BOTH GAMES.**

**This rule applies to ANY code that implements game engine functionality, file format parsing,**
**or any behavior that must match the original game engines.**

### Requirements

1. **Always analyze BOTH games** when implementing core functionality:
   - **KotOR I (swkotor.exe)**: Primary reference
   - **KotOR II / TSL (swkotor2.exe)**: Secondary reference for verification and parity

2. **Unified Documentation Pattern**:
   - Document both games together, not in separate sections
   - Show conditional logic (`#ifdef KOTOR_1` / `#else`) where implementations differ
   - Use unified code examples that work for both games
   - Only highlight differences inline where they occur

3. **Inline Comments Pattern**:
   ```
   # Reference: K1 swkotor.exe:0xADDRESS, TSL swkotor2.exe:0xADDRESS
   ```

4. **Verification Process**:
   - Use `mcp_reva_open-project` to open Ghidra project with both executables
   - Use `mcp_reva_get-functions-by-similarity` to find equivalent functions
   - Use `mcp_reva_get-decompilation` to compare implementations
   - Document differences inline with conditional code examples
   - Ensure implementation works for both games

5. **When Both Games Must Match**:
   - File format parsers/writers
   - Game mechanics implementations
   - Resource loading/saving
   - Any code that processes game data files
   - Any code that must produce identical output to the engines

6. **Exceptions** (only when explicitly justified):
   - Game-specific features (e.g., TSL-only functions)
   - Features that only exist in one game
   - Must be clearly documented with "K1-only" or "TSL-only" labels

### Example

When implementing ASCII walkmesh parsing:
- Analyze `CSWRoomSurfaceMesh::LoadMeshText` in swkotor.exe (0x00582d70)
- Analyze equivalent function in swkotor2.exe (0x00577860)
- Compare both implementations
- Document in unified format with conditional logic where they differ:
  ```c
  #ifdef KOTOR_1
      C2DA::GetINTEntry(surfacemat_2da, material_id, "Walk", &result);
  #else  // TSL
      FUN_0041d630(surfacemat_2da, material_id, "Walk", &result);
  #endif
  ```

### Tools Required

- `mcp_reva_open-project` - Open Ghidra project
- `mcp_reva_get-functions-by-similarity` - Find functions in both games
- `mcp_reva_get-decompilation` - Get decompiled code
- `mcp_reva_find-cross-references` - Find callers/callees
- `mcp_reva_get-strings-by-similarity` - Find string literals

## Final Rule

Follow these rules exactly.
Every deviation is a violation.
