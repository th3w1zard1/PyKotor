# PyKotor AI Agent Guidelines (2026)

You are an AI agent for PyKotor, a Python library and tools for modding Knights of the Old Republic games. Adhere strictly to these rules for code quality, type safety, game fidelity, and repository integrity.

## 1. Git Operations

### Commits

Commit changes using this exact chained format:

```powershell
git add file1.py file2.py; git commit -m "type: message"
```

- Specify only modified file paths; avoid wildcards.
- Use commit types: `feat:`, `fix:`, `refactor:`, `docs:`, `chore:`, `test:`.
- Allow pre-commit hooks to run and pass without bypass.

### General Practices

- Append `--no-pager` to paging commands.
- Preserve existing working-tree changes.
- For cleanups, snapshot first (e.g., `git stash push --include-untracked` with paths).
- Obtain user approval before destructive actions (e.g., `git restore`, `git reset`, `git clean`), quoting the command.
- Limit to 2â€“3 commands per clean commit; note unresolved paths for user if needed.

## 2. Static Type Checking

Run `mypy --strict` and `pyright` via pre-commit hooks on all `.py` files (exclude `.` folders and root `vendor/`).

Fix all type errors before committing. Use suppression only in justified cases:

| Mechanism                  | Banned Unless Justified For                  |
|----------------------------|----------------------------------------------|
| `# type: ignore`, `# pyright: ignore` | Untyped third-party libraries (no stubs)    |
| Specific ignore codes      | Temporary legacy migration (add TODO + plan) |
| `getattr()` / `hasattr()` for typing | Rare runtime introspection                   |
| `__dict__` access, `__getattr__` |                                              |
| `typing.cast()`, excessive `typing.Any` |                                              |
| Type-related `# noqa`     |                                              |

Favor annotations and `isinstance()` checks.

## 3. Documentation and Wiki

- Place new `.md` files only in `docs/`.
- Focus content on public-facing info (users/developers).

### Verification

Verify technical claims with at least 3 independent sources:

- Limit one from `Libraries/PyKotor/src`.
- Prioritize engine/vendor (e.g., vendor projects, wiki).
- Cite external URLs; confirm validity.
- If sources insufficient: retain behavior, add `TODO: <implementation_details>`, or request vendor files from user.

### Wiki Maintenance

On new discoveries (formats, mechanics, relationships):

1. Check or create `wiki/*.md`.
2. Update content.
3. Commit separately:

```powershell
cd wiki; git add file.md; git commit -m "docs: description"  # Commit to PyKotor.wiki.git
cd ..; git add wiki/file.md; git commit -m "docs: description"  # Commit to PyKotor.git repo
```

## 4. Code and Tool Conventions

- Reference similar code in `./vendor` with path/line comments.
- Prefer `isinstance` over `hasattr`/`getattr`.
- Use `ruff` solely for linting.
- Avoid editing generated files; fix sources and regenerate.
- Favor PyKotor CLI over raw Python:

```bash
uv run Libraries/PyKotor/src/pykotor/cli/__main__.py <command>
```

Use commands like `list`, `extract`, `search-archive`, `diff`, `validate`.

- For helper scripts in `scripts/`: Implement `argparse` with defaults, POSIX flags, multiple formats, proper exits. Maintain indefinitely.

## 5. Testing and Environment

- Enforce timeouts: 120s per test, 300s per suite. Example:

```powershell
. .\.venv_3.13\Scripts\Activate.ps1
$proc = Start-Process python -ArgumentList "-m pytest tests/..." -PassThru -NoNewWindow
if (-not $proc.WaitForExit(300000)) { $proc.Kill(); Write-Host "TIMEOUT" }
```

- Use `uv run` over direct `python`.
- Reference paths via env vars (`$Env:K1_PATH`, `$Env:K2_PATH`, `$Env:TSL_PATH`).
- Execute from repo root for `PYTHONPATH`.

## 6. Core Game Implementation

For engine features, formats, mechanics, resources:

- Analyze both KotOR I (`swkotor.exe`) and KotOR II/TSL (`swkotor2.exe`) using REVA MCP tools.
- open-project <path to .gpr>. Usually this is %USERPROFILE%\test.gpr but remember to RESOLVE %userprofile% manually! e.g. C:\Users\boden\test.gpr
- Use unified K1/TSL naming.
- Format addresses: `FunctionName - K1: 0xADDRESS, TSL: 0xADDRESS` (once if same).
- Highlight differences; use conditionals for divergences.
- Comment: `# Reference: K1 swkotor.exe:0xADDRESS, TSL swkotor2.exe:0xADDRESS`
- Compare via `mcp_reva_*` tools for decompilations, similarities, references.
- Label game-specific exceptions clearly.

Adhere fully to ensure project consistency, safety, and fidelity.


**Key Citations**

- [PromptingGuide.ai General Tips and Elements of a Prompt](https://www.promptingguide.ai/introduction/tips)
- [OpenAI Best Practices for Prompt Engineering](https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-the-openai-api)
- [Anthropic Effective Context Engineering for AI Agents](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
- [Lakera Ultimate Guide to Prompt Engineering in 2025](https://www.lakera.ai/blog/prompt-engineering-guide)
- [PromptLayer Token Reduction Insights](https://www.promptlayer.com/blog/token-reduction)
- [Uptech Concise Prompting Guide](https://uptech.com/blog/concise-prompting)
- [Reddit r/PromptEngineering Best Practices Thread (2025)](https://www.reddit.com/r/PromptEngineering/comments/best-practices-2025)
- [Microsoft Prompt Engineering Guide (2025)](https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/prompt-engineering)
- [Google DeepMind Prompting Best Practices (2026 Update)](https://deepmind.google/technologies/gemini/prompting-guide)
- [General Insights from Hugging Face Prompt Engineering Hub](https://huggingface.co/docs/transformers/prompt_engineering)
