name: Release Readiness Check

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool name (matches tool directory or build name; e.g., toolset, holopatcher, kotordiff)'
        required: true
        type: string
      version:
        description: 'Version to release (e.g., 3.1.3)'
        required: true
      run_full_build:
        description: 'Run full builds for all platforms'
        required: false
        default: false
        type: boolean

concurrency:
  group: release-ready-${{ github.event.inputs.tool }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-version:
    name: Validate Version Format
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
      config_file: ${{ steps.validate.outputs.config_file }}
      version_key: ${{ steps.validate.outputs.version_key }}
      tool_dir: ${{ steps.validate.outputs.tool_dir }}
      build_name: ${{ steps.validate.outputs.build_name }}
      display_name: ${{ steps.validate.outputs.display_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format and locate tool
        id: validate
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import re
          import sys
          from pathlib import Path

          version = os.environ["INPUT_VERSION"].strip()
          tool_input = os.environ["INPUT_TOOL"].strip().lower()

          print(f"=== Validating version {version} for {tool_input} ===")

          # Validate version format (semver-like)
          if not re.fullmatch(r"[0-9]+\.[0-9]+(\.[0-9]+)?(-[A-Za-z0-9.]+)?", version):
            print(f"âŒ Invalid version format: {version}")
            print("   Expected format: MAJOR.MINOR[.PATCH][-suffix]")
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
            sys.exit(1)
          print("âœ“ Version format is valid")

          tools_dir = Path("Tools")
          if not tools_dir.exists():
            print("âŒ Tools directory not found")
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
            sys.exit(1)

          def derive_build_name(tool_dir_name: str) -> str:
            name_lower = tool_dir_name.lower()
            special_mappings = {
              "holocrontoolset": "toolset",
            }
            return special_mappings.get(name_lower, name_lower)

          def find_config_file(tool_dir: Path, tool_name_lower: str) -> Path | None:
            src_dir = tool_dir / "src" / tool_name_lower
            config_py = src_dir / "config.py"
            if config_py.exists():
              return config_py
            config_info_py = src_dir / "config" / "config_info.py"
            if config_info_py.exists():
              return config_info_py
            main_py = src_dir / "__main__.py"
            if main_py.exists():
              content = main_py.read_text()
              if "CURRENT_VERSION" in content:
                return main_py
            init_py = src_dir / "__init__.py"
            if init_py.exists():
              content = init_py.read_text()
              if "__version__" in content:
                return init_py
            return None

          tools = []
          for tool_path in sorted(tools_dir.iterdir()):
            if tool_path.is_dir() and not tool_path.name.startswith("."):
              t_lower = tool_path.name.lower()
              build_name = derive_build_name(tool_path.name)
              config_path = find_config_file(tool_path, t_lower)
              tools.append(
                {
                  "tool_dir": tool_path.name,
                  "tool_dir_lower": t_lower,
                  "build_name": build_name,
                  "config_file": str(config_path) if config_path else "",
                  "display_name": tool_path.name,
                }
              )

          matching = [
            t for t in tools
            if t["build_name"] == tool_input or t["tool_dir_lower"] == tool_input
          ]

          if not matching:
            print("âŒ Unknown tool selection.")
            if tools:
              print("Available tools (build_name -> dir):")
              for t in tools:
                print(f"  - {t['build_name']} -> Tools/{t['tool_dir']}")
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
            sys.exit(1)

          tool = matching[0]
          config_path = tool["config_file"]

          if not config_path:
            print(f"âŒ Could not find a config/version file for {tool['display_name']}")
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
            sys.exit(1)

          config_path = Path(config_path)
          if not config_path.exists():
            print(f"âŒ Config file not found: {config_path}")
            print("valid=false", file=open(os.environ["GITHUB_OUTPUT"], "a"))
            sys.exit(1)

          content = config_path.read_text()
          version_key = None
          current = ""

          if '"currentVersion":' in content:
            version_key = "currentVersion"
            match = re.search(r'"currentVersion":\s*"([^"]+)"', content)
            current = match.group(1) if match else ""
          elif "CURRENT_VERSION" in content:
            version_key = "CURRENT_VERSION"
            match = re.search(r'CURRENT_VERSION\s*=\s*["\']([^"\']+)["\']', content)
            current = match.group(1) if match else ""
          elif "__version__" in content:
            version_key = "__version__"
            match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
            current = match.group(1) if match else ""
          else:
            version_key = "unknown"

          print(f"âœ“ Found tool: {tool['display_name']} (build_name: {tool['build_name']})")
          print(f"âœ“ Config file: {config_path}")
          print(f"  Version key: {version_key}")
          print(f"  Current version: {current}")
          print(f"  Target version: {version}")

          if current == version:
            print(f"âš ï¸  Warning: Version already set to {version}")

          tag_name = f"v{version}-{tool['build_name']}"

          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
            gh_out.write("valid=true\n")
            gh_out.write(f"config_file={config_path}\n")
            gh_out.write(f"version_key={version_key}\n")
            gh_out.write(f"tag_name={tag_name}\n")
            gh_out.write(f"tool_dir={tool['tool_dir']}\n")
            gh_out.write(f"build_name={tool['build_name']}\n")
            gh_out.write(f"display_name={tool['display_name']}\n")

          print("")
          print("=== Version validation passed ===")
          print(f"  Tool: {tool['display_name']} ({tool['build_name']})")
          print(f"  Version: {version}")
          print(f"  Tag: {tag_name}")
          print(f"  Config: {config_path}")
          PYTHON_SCRIPT
        env:
          INPUT_TOOL: ${{ github.event.inputs.tool }}
          INPUT_VERSION: ${{ github.event.inputs.version }}

  check-tag:
    name: Check Tag Availability
    runs-on: ubuntu-latest
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag already exists
        run: |
          TAG="${{ needs.validate-version.outputs.tag_name }}"

          git fetch --tags

          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Warning: Tag $TAG already exists"
            echo "   This tag will be overwritten if you proceed with the release"

            TAG_COMMIT=$(git rev-list -n 1 "refs/tags/$TAG" 2>/dev/null || echo "unknown")
            echo "   Current tag commit: $TAG_COMMIT"
          else
            echo "âœ“ Tag $TAG is available"
          fi
        shell: bash

  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Verify installation and config readability
        run: |
          TOOL_DIR="${{ needs.validate-version.outputs.tool_dir }}"
          CONFIG_FILE="${{ needs.validate-version.outputs.config_file }}"

          pip install -e "Libraries/PyKotor[all]" --quiet
          pip install -e "Tools/${TOOL_DIR}" --quiet 2>/dev/null || true

          python3 << 'PYTHON_SCRIPT'
          import re
          from pathlib import Path
          config_path = Path("${{ needs.validate-version.outputs.config_file }}")
          if not config_path.exists():
              raise SystemExit(f"Config file missing after install: {config_path}")
          content = config_path.read_text()
          version = "unknown"
          if '"currentVersion":' in content:
              match = re.search(r'"currentVersion":\s*"([^"]+)"', content)
              version = match.group(1) if match else version
          elif "CURRENT_VERSION" in content:
              match = re.search(r'CURRENT_VERSION\s*=\s*["\']([^"\']+)["\']', content)
              version = match.group(1) if match else version
          elif "__version__" in content:
              match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
              version = match.group(1) if match else version
          print(f"âœ“ Installed tool config readable; detected version: {version}")
          PYTHON_SCRIPT

  check-compile-scripts:
    name: Check Compile Scripts
    runs-on: ubuntu-latest
    needs: validate-version
    if: needs.validate-version.outputs.valid == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Verify compile scripts exist
        run: |
          BUILD_NAME="${{ needs.validate-version.outputs.build_name }}"

          CANDIDATES=(
            "compile/compile_${BUILD_NAME}.ps1"
            "compile/compile_${BUILD_NAME}.sh"
            "compile/compile_${BUILD_NAME}.bat"
          )
          DEPS_CANDIDATES=(
            "compile/deps_${BUILD_NAME}.ps1"
            "compile/deps_${BUILD_NAME}.sh"
            "compile/deps_${BUILD_NAME}.bat"
          )

          echo "=== Checking compile scripts for ${BUILD_NAME} ==="

          FOUND_COMPILE=""
          for c in "${CANDIDATES[@]}"; do
            if [ -f "$c" ]; then
              echo "âœ“ Compile script exists: $c"
              FOUND_COMPILE="$c"
              break
            fi
          done

          if [ -z "$FOUND_COMPILE" ]; then
            echo "âŒ Compile script NOT found for ${BUILD_NAME}"
            exit 1
          fi

          FOUND_DEPS="false"
          for d in "${DEPS_CANDIDATES[@]}"; do
            if [ -f "$d" ]; then
              echo "âœ“ Dependencies script exists: $d"
              FOUND_DEPS="true"
              break
            fi
          done

          if [ "$FOUND_DEPS" = "false" ]; then
            echo "âš ï¸  Dependencies script not found (may not be required)"
          fi
        shell: bash

  dry-run-build:
    name: Dry Run Build (${{ matrix.os }})
    needs: [validate-version, check-dependencies, check-compile-scripts]
    if: needs.validate-version.outputs.valid == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-20.04]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Build validation (dry run)
        uses: ./.github/actions/build-tool
        with:
          tool_name: ${{ needs.validate-version.outputs.build_name }}
          python_version: '3.8'
          architecture: x64
          qt_version: ${{ needs.validate-version.outputs.build_name == 'toolset' && 'PyQt5' || '' }}
          dry_run: ${{ github.event.inputs.run_full_build != 'true' && 'true' || 'false' }}
          upload_artifact: ${{ github.event.inputs.run_full_build }}
          artifact_retention_days: '3'

  full-build-matrix:
    name: Full Build (${{ matrix.os }} ${{ matrix.architecture }})
    needs: [validate-version, check-dependencies, check-compile-scripts]
    if: needs.validate-version.outputs.valid == 'true' && github.event.inputs.run_full_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-20.04, macos-12]
        architecture: [x64, x86]
        exclude:
          - os: ubuntu-20.04
            architecture: x86
          - os: macos-12
            architecture: x86
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Build tool
        uses: ./.github/actions/build-tool
        with:
          tool_name: ${{ needs.validate-version.outputs.build_name }}
          python_version: '3.8'
          architecture: ${{ matrix.architecture }}
          qt_version: ${{ needs.validate-version.outputs.build_name == 'toolset' && 'PyQt5' || '' }}
          dry_run: 'false'
          upload_artifact: 'true'
          artifact_retention_days: '7'

  summary:
    name: Release Readiness Summary
    needs: [validate-version, check-tag, check-dependencies, check-compile-scripts, dry-run-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Release Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tool:** ${{ needs.validate-version.outputs.display_name }} (build: ${{ needs.validate-version.outputs.build_name }})" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.validate-version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-version.result }}" = "success" ]; then
            echo "- âœ… Version format validated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Version validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-tag.result }}" = "success" ]; then
            echo "- âœ… Tag availability checked" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Tag check failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-dependencies.result }}" = "success" ]; then
            echo "- âœ… Dependencies validated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Dependencies check failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-compile-scripts.result }}" = "success" ]; then
            echo "- âœ… Compile scripts found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Compile scripts check failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dry-run-build.result }}" = "success" ]; then
            echo "- âœ… Build validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Build validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ALL_PASSED="true"
          if [ "${{ needs.validate-version.result }}" != "success" ] || \
             [ "${{ needs.check-dependencies.result }}" != "success" ] || \
             [ "${{ needs.check-compile-scripts.result }}" != "success" ] || \
             [ "${{ needs.dry-run-build.result }}" != "success" ]; then
            ALL_PASSED="false"
          fi

          if [ "$ALL_PASSED" = "true" ]; then
            echo "ðŸŽ‰ **All checks passed!** You're ready to release." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Update version key (\`${{ needs.validate-version.outputs.version_key }}\`) to \`${{ github.event.inputs.version }}\` in the config file" >> $GITHUB_STEP_SUMMARY
            echo "2. Commit and push to master" >> $GITHUB_STEP_SUMMARY
            echo "3. Create a pre-release with tag: \`${{ needs.validate-version.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "4. The release workflow will handle everything else automatically" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some checks failed.** Please fix the issues before releasing." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the failed jobs above and address any errors." >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash
