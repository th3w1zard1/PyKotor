name: Issue Automation

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  label-issues:
    name: Auto-label Issues
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-label based on title
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const title = context.payload.issue?.title || '';
            const body = context.payload.issue?.body || '';
            const labels = [];
            const lcBody = body.toLowerCase();

            // Discover tools dynamically from Tools/ (HolocronToolset -> toolset)
            const toolsDir = path.join(process.cwd(), 'Tools');
            let tools = [];
            const deriveBuildName = (name) => {
              const lower = name.toLowerCase();
              if (lower === 'holocrontoolset') return 'toolset';
              return lower;
            };
            if (fs.existsSync(toolsDir)) {
              tools = fs.readdirSync(toolsDir, { withFileTypes: true })
                .filter((d) => d.isDirectory() && !d.name.startsWith('.'))
                .map((d) => ({
                  dir: d.name,
                  build: deriveBuildName(d.name),
                }));
            }

            // Label based on title prefixes
            if (title.startsWith('[BUG]') || title.startsWith('[bug]')) {
              labels.push('bug');
            }
            if (title.startsWith('[FEATURE]') || title.startsWith('[feature]')) {
              labels.push('enhancement');
            }
            if (title.startsWith('[DOCS]') || title.startsWith('[docs]')) {
              labels.push('documentation');
            }
            if (title.startsWith('[QUESTION]') || title.startsWith('[question]')) {
              labels.push('question');
            }
            if (title.startsWith('[PERF]') || title.startsWith('[perf]')) {
              labels.push('performance');
            }
            if (title.startsWith('[SECURITY]') || title.startsWith('[security]')) {
              labels.push('security');
            }

            // Label based on package mentions (dynamic tools + known packages)
            const addPackageLabel = (pkg) => labels.push(`package: ${pkg}`);

            if (lcBody.includes('pykotor') && !lcBody.includes('pykotorgl')) {
              addPackageLabel('pykotor');
            }
            if (lcBody.includes('pykotorgl')) {
              addPackageLabel('pykotorgl');
            }

            for (const t of tools) {
              const dirMatch = lcBody.includes(t.dir.toLowerCase());
              const buildMatch = lcBody.includes(t.build.toLowerCase());
              if (dirMatch || buildMatch) {
                addPackageLabel(t.build);
              }
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels,
              });
            }

  welcome-new-contributors:
    name: Welcome New Contributors
    runs-on: ubuntu-latest
    steps:
      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) return;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
            });

            // Check if this is the user's first issue
            const { data: userIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: issue.user.login,
              state: 'all',
            });

            const isFirstIssue = userIssues.filter(i => i.number < issue.number).length === 0;

            if (isFirstIssue && issue.user.type === 'User') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ‘‹ Welcome to PyKotor, @${issue.user.login}! Thanks for your first issue. We appreciate your contribution! ğŸ‰\n\nPlease make sure to:\n- Check [CONTRIBUTING.md](https://github.com/OldRepublicDevs/PyKotor/blob/master/CONTRIBUTING.md) for guidelines\n- Review the [documentation](https://github.com/OldRepublicDevs/PyKotor/tree/master/docs) if needed\n\nWe'll review your issue soon!`,
              });
            }
