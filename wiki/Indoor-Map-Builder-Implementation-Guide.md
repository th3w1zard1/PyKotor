# Indoor Map Builder - Implementation Guide

**Implementation (headless core):** [`Libraries/PyKotor/src/pykotor/common/indoormap.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoormap.py)

**Workflows (CLI/tooling helpers):** [`Libraries/PyKotor/src/pykotor/tools/indoormap.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/tools/indoormap.py)

**Related Components:**

- [`Tools/HolocronToolset/src/toolset/data/indoorkit/`](https://github.com/OldRepublicDevs/PyKotor/tree/master/Tools/HolocronToolset/src/toolset/data/indoorkit) - Kit system implementation
- [`Tools/HolocronToolset/src/toolset/gui/windows/indoor_builder.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Tools/HolocronToolset/src/toolset/gui/windows/indoor_builder.py) - Qt UI implementation
- [`Tools/HolocronToolset/src/toolset/kits/`](https://github.com/OldRepublicDevs/PyKotor/tree/master/Tools/HolocronToolset/src/toolset/kits) - Kit data (ToolsetData submodule)

**See Also:**

- [Kit Structure Documentation](Kit-Structure-Documentation) - Detailed kit file format reference
- [Indoor Map Builder User Guide](Indoor-Map-Builder-User-Guide) - End-user documentation
- [LYT File Format](LYT-File-Format) - Layout format generated by builder
- [BWM File Format](BWM-File-Format) - [walkmesh](BWM-File-Format) format used by rooms
- [VIS File Format](VIS-File-Format) - Visibility format generated by builder
- [ERF File Format](ERF-File-Format) - [module archives](ERF-File-Format) format for output
- [GFF-ARE](GFF-ARE) - [area files](GFF-File-Format#are-area) format generated by builder

## Architecture Overview

The Indoor Map Builder is a complex system that combines several subsystems:

1. **data Layer**: `IndoorMap`, `IndoorMapRoom`, `Kit`, `KitComponent` - Core data structures
2. **UI Layer**: `IndoorMapBuilder`, `IndoorMapRenderer` - Qt-based user interface
3. **Kit System**: Kit loading and component management
4. **Module Converter**: Converts game modules to kit-like components
5. **Build System**: Converts map data to game module files
6. **Rendering System**: 2D top-down view with [walkmesh](BWM-File-Format) visualization

## Core data structures

### IndoorMap

The root data structure representing a complete indoor module.

**Location**: [`Libraries/PyKotor/src/pykotor/common/indoormap.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoormap.py)

**Key Properties**:

- `rooms: list[IndoorMapRoom]` - All rooms in the map
- `module_id: str` - Module identifier (warp code)
- `name: LocalizedString` - Module display name
- `lighting: Color` - Ambient lighting color
- `skybox: str` - Optional skybox [model](MDL-MDX-File-Format) name
- `warp_point: Vector3` - Player spawn location

**Key Methods**:

- `write() -> bytes`: Serializes map to JSON format
- `load(raw: bytes, kits: list[Kit]) -> list[MissingRoomInfo]`: Loads map from JSON
- `build(installation, kits, output_path)`: Builds complete module files
- `rebuild_room_connections()`: Recalculates room hook connections

**file format** (`.indoor`):

```json
{
  "module_id": "test01",
  "name": {"stringref": -1, "0": "New Module"},
  "lighting": [0.5, 0.5, 0.5],
  "skybox": "",
  "warp": "test01",
  "rooms": [
    {
      "position": [0.0, 0.0, 0.0],
      "rotation": 0.0,
      "flip_x": false,
      "flip_y": false,
      "kit": "kit_name",
      "component": "component_name",
      "walkmesh_override": "base64_encoded_bwm_data"
    }
  ]
}
```

### IndoorMapRoom

Represents a single room instance placed in the map.

**Location**: [`Libraries/PyKotor/src/pykotor/common/indoormap.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoormap.py)

**Key Properties**:

- `component: KitComponent` - The component template
- `position: Vector3` - World position
- `rotation: float` - rotation in degrees
- `flip_x: bool` - Horizontal flip
- `flip_y: bool` - Vertical flip
- `hooks: list[IndoorMapRoom | None]` - Connected rooms (by hook index)
- `walkmesh_override: BWM | None` - Custom walkmesh (for painting)

**Key Methods**:

- `hook_position(hook, world_offset=True) -> Vector3`: Calculates hook world position
- `rebuild_connections(rooms)`: Rebuilds hook connections
- `walkmesh() -> BWM`: Returns transformed [walkmesh](BWM-File-Format)
- `base_walkmesh() -> BWM`: Returns untransformed walkmesh (honors override)
- `ensure_walkmesh_override() -> BWM`: Creates writable override copy

**Connection System**:

- Hooks connect when within 0.001 units of each other
- Connections [ARE](GFF-File-Format#are-area) bidirectional (room1.hooks[i] = room2, room2.hooks[j] = room1)
- Rebuilt automatically when rooms move

### Kit

A collection of reusable room components.

**Location (data model)**: [`Libraries/PyKotor/src/pykotor/common/indoorkit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoorkit.py)

**Location (loaders/workflows)**: [`Libraries/PyKotor/src/pykotor/tools/indoorkit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/tools/indoorkit.py)

**Key Properties**:

- `name: str` - Kit name
- `components: list[KitComponent]` - Available components
- `doors: list[KitDoor]` - Door types
- `textures: CaseInsensitiveDict[bytes]` - [texture](TPC-File-Format) data
- `lightmaps: CaseInsensitiveDict[bytes]` - Lightmap data
- `txis: CaseInsensitiveDict[bytes]` - [texture](TPC-File-Format) info data
- `always: dict[Path, bytes]` - Always-included resources
- `side_padding: dict[int, dict[int, MDLMDXTuple]]` - Door width padding [models](MDL-MDX-File-Format)
- `top_padding: dict[int, dict[int, MDLMDXTuple]]` - Door height padding [models](MDL-MDX-File-Format)
- `skyboxes: dict[str, MDLMDXTuple]` - Skybox [models](MDL-MDX-File-Format)

**Loading**:

- Loaded from JSON files in `./kits/` directory
- Each kit has a directory with components, [textures](TPC-File-Format), lightmaps, etc.
- See `indoorkit_loader.py` for loading implementation

### KitComponent

A reusable room template.

**Location (data model)**: [`Libraries/PyKotor/src/pykotor/common/indoorkit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoorkit.py)

**Key Properties**:

- `kit: Kit` - Parent kit
- `name: str` - Component name
- `image: QImage` - Preview image (128x128 or larger)
- `bwm: BWM` - [walkmesh](BWM-File-Format) data
- `mdl: bytes` - [model](MDL-MDX-File-Format) data
- `mdx: bytes` - [model](MDL-MDX-File-Format) extension data
- `hooks: list[KitComponentHook]` - Connection points

### KitComponentHook

A connection point on a component.

**Location (data model)**: [`Libraries/PyKotor/src/pykotor/common/indoorkit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoorkit.py)

**Key Properties**:

- `position: Vector3` - Local position (relative to component center)
- `rotation: float` - rotation in degrees
- `edge: str` - [edge](BWM-File-Format#edges) index (for transition remapping)
- `door: KitDoor` - Door type for this hook

**coordinate System**:

- Hooks use **local coordinates** (centered at origin)
- Transformed to world coordinates via `IndoorMapRoom.hook_position()`
- [transformation](BWM-File-Format#walkable-adjacencies) order: flip → rotate → translate

### KitDoor

Defines a door type with K1/K2 variants.

**Location**: [`Libraries/PyKotor/src/pykotor/common/indoorkit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/indoorkit.py)

**Key Properties**:

- `utd_k1: UTD` - K1 door blueprint
- `utd_k2: [UTD](GFF-File-Format#utd-door)` - K2 door blueprint
- `width: float` - Door width
- `height: float` - Door height

## Module Converter System

The module converter allows using game modules as component sources.

**Core (headless) Location**: [`Libraries/PyKotor/src/pykotor/common/modulekit.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Libraries/PyKotor/src/pykotor/common/modulekit.py)

**Toolset Qt Preview Helper**: [`Tools/HolocronToolset/src/toolset/data/indoorkit/qt_preview.py`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Tools/HolocronToolset/src/toolset/data/indoorkit/qt_preview.py)

### ModuleKit

A dynamically-generated kit from a game module.

**Key Features**:

- Lazy loading: Only loads when selected
- Extracts rooms from module [LYT files](LYT-File-Format)
- Generates preview images from [walkmeshes](BWM-File-Format)
- Extracts hooks from [BWM](BWM-File-Format) transition [edges](BWM-File-Format#edges)

**Loading Process**:

1. Load module using `Module` class
2. Extract [LYT](LYT-File-Format) resource
3. For each [LYT](LYT-File-Format) room:
   - Load WOK ([walkmesh](BWM-File-Format)) resource
   - Convert [BWM](BWM-File-Format) to room-local space by removing the LYT translation
   - Generate preview image from [BWM](BWM-File-Format)
   - Extract hooks from [BWM](BWM-File-Format) transitions
   - Create `KitComponent`

**[BWM](BWM-File-Format) Coordinate Space**:

- Module WOK/BWM data is commonly authored in module/world coordinates (matching LYT positions).
- The model (MDL) keeps its own local origin; the engine places it using the LYT room position.
- To keep the visual model and physical walkmesh aligned, the converter must put the BWM in the **same local space** as the model by subtracting the LYT room position:
  - \(bwm.translate(-lyt\_room.position.x, -lyt\_room.position.y, -lyt\_room.position.z)\)
- Do **not** bbox-center the walkmesh, because many rooms have non-centered origins (e.g. hallways); bbox-centering shifts collision relative to visuals.

**Build-time WOK export (critical runtime detail):**

- When *building* a `.mod` from an `.indoor`, the builder bakes the LYT room transform into each exported room WOK so the engine consumes the walkmesh in world space.
- After baking translation into vertices, the builder must set the walkmesh header flag at offset `0x08` (`world_coords`) to `1` (world-space / WOK / `BWMType.AreaModel`). Leaving this as `0` can cause the engine to treat vertices as local-space and apply transforms again, resulting in the player spawning with no walkable face underfoot (appearing “stuck”).

**Area lighting (why “pitch black” can happen):**

- `ARE.DynAmbientColor` alone is not sufficient for usable lighting in-game.
- The builder should set `ARE.SunAmbientColor` and `ARE.SunDiffuseColor` (and can mirror the same `IndoorMap.lighting` value into all three fields for a sane default).

**Preview Image Generation**:

- Matches `kit.py:_generate_component_minimap()` exactly
- 10 pixels per unit scale
- Format_RGB888
- Minimum 256x256 pixels
- Mirrored to match kit loader behavior

### ModuleKitManager

Manages lazy loading and caching of ModuleKits.

**Key Methods**:

- `get_module_roots() -> list[str]`: Lists available modules
- `get_module_display_name(module_root) -> str`: Gets display name
- `get_module_kit(module_root) -> ModuleKit`: Gets or creates kit
- `clear_cache()`: Frees memory

## Build Process

The build process converts `IndoorMap` data to game module files.

**Location**: [`Tools/HolocronToolset/src/toolset/data/indoormap.py:build()`](https://github.com/OldRepublicDevs/PyKotor/blob/master/Tools/HolocronToolset/src/toolset/data/indoormap.py#L100)

### Build Steps

1. **Initialize Resources**:
   - Create ERF ([module archives](ERF-File-Format))
   - Create LYT (layout)
   - Create VIS (visibility)
   - Create ARE (area)
   - Create IFO ([module info](GFF-File-Format#ifo-module-info))
   - Create GIT ([game instance template](GFF-File-Format#git-game-instance-template))

2. **Process Rooms**:
   - Add rooms to [VIS](VIS-File-Format) graph
   - Process room components ([textures](TPC-File-Format), [models](MDL-MDX-File-Format), lightmaps)
   - Handle [texture](TPC-File-Format) renaming (avoid conflicts)
   - Process lightmaps (rename, load from installation if missing)
   - Process BWM (flip, rotate, translate, remap transitions)
   - Add [models](MDL-MDX-File-Format) and [walkmeshes](BWM-File-Format) to [ERF](ERF-File-Format)

3. **Handle Doors**:
   - Generate door insertions from room connections
   - Create [GIT](GFF-File-Format#git-game-instance-template) door objects
   - Create [UTD](GFF-File-Format#utd-door) door blueprints
   - Add door padding models (for height/width mismatches)
   - Add doorhooks to [LYT](LYT-File-Format)

4. **Process Skybox**:
   - Load skybox [model](MDL-MDX-File-Format) from kits
   - Add to [LYT](LYT-File-Format) and [VIS](VIS-File-Format)

5. **Generate Minimap**:
   - Render top-down view of all rooms
   - Create 512x256 [TPC](TPC-File-Format) [texture](TPC-File-Format)
   - Set [ARE](GFF-File-Format#are-area) map points

6. **Finalize**:
   - Set [ARE](GFF-File-Format#are-area) attributes (lighting, name, map points)
   - Set [IFO](GFF-File-Format#ifo-module-info) attributes (module ID, entry point)
   - Write all resources to [ERF file](ERF-File-Format)

### [texture](TPC-File-Format) Renaming

[textures](TPC-File-Format) [ARE](GFF-File-Format#are-area) renamed to avoid conflicts:

- Pattern: `{module_id}_tex{N}`
- All references updated in [models](MDL-MDX-File-Format) and [TXI files](TXI-File-Format)

### Lightmap Processing

Lightmaps [ARE](GFF-File-Format#are-area) processed per-room:

- Renamed: `{module_id}_lm{N}`
- Loaded from kit first, then installation if missing
- [TXI files](TXI-File-Format) included if available
- If falling back to an installation [TPC](TPC-File-Format), the bytes must be encoded as **TGA** before writing `ResourceType.TGA` (e.g. `bytes_tpc(tpc, ResourceType.TGA)`), not raw TPC bytes.

### [BWM](BWM-File-Format) Processing

Each room's [BWM](BWM-File-Format) is transformed:

1. Deep copy (preserve original)
2. Apply flip (if `flip_x` or `flip_y`)
3. Apply rotation
4. Apply translation (room position)
5. Remap transition indices (connect to actual room indices)

### Door Insertions

Doors [ARE](GFF-File-Format#are-area) inserted at hook connection points:

- One door per hook pair
- Door type chosen from larger door (width/height)
- Static doors for unconnected hooks
- Padding [models](MDL-MDX-File-Format) added for size mismatches

## Rendering System

The renderer provides a 2D top-down view of the map.

**Location**: `Tools/HolocronToolset/src/toolset/gui/windows/indoor_builder.py:IndoorMapRenderer`

### coordinate Systems

**World coordinates**: Game world space (X, Y, Z)

- Rooms positioned in world space
- [walkmeshes](BWM-File-Format) in world space after [transformation](BWM-File-Format#walkable-adjacencies)

**Screen coordinates**: Widget pixel coordinates (X, Y)

- Mouse position
- Widget size

**Render coordinates**: Transformed screen coordinates

- Camera transform applied
- rotation, scale, translation

### Camera System

**Properties**:

- `_cam_position: Vector2` - Camera center in world space
- `_cam_rotation: float` - Camera rotation in radians
- `_cam_scale: float` - Zoom level

**Transform Pipeline**:

1. Translate to center
2. Rotate by camera rotation
3. scale by zoom
4. Translate by camera position

### Rendering Loop

**Optimization**: Only repaints when dirty

- `_dirty: bool` [flag](GFF-File-Format#gff-data-types)
- `mark_dirty()` called on changes
- ~60 FPS target (16ms timer)

**Render Order**:

1. Background
2. Grid (if enabled)
3. Room [walkmeshes](BWM-File-Format)
4. Hook markers (red = unconnected, green = connected, blue = selected)
5. Connection lines
6. Cursor preview
7. Snap indicator (anchored at the actual hook snap point)
8. Hover highlight
9. Selection highlights
10. Warp point
11. Marquee selection

### Status Bar

**Location**: `IndoorMapBuilder._setup_status_bar()` / `_update_status_bar()`

- Mirrors the Module Designer style (rich text, emoji-friendly).
- Displays:
  - **Coords**: World X/Y under cursor.
  - **Hover**: Room under cursor (if any).
  - **Selection**: Selected hook (room + index) or selected room count.
  - **Keys/Buttons**: Currently held keyboard modifiers and mouse buttons.
  - **Status**: Paint mode/[material](MDL-MDX-File-Format#trimesh-header), colorization [flag](GFF-File-Format#gff-data-types), snap modes (grid/hook).
- Updated from renderer mouse/scroll/press/release signals via a callback set on `IndoorMapRenderer`.

### [walkmesh](BWM-File-Format) Visualization

Rooms rendered using [walkmesh](BWM-File-Format) geometry (not preview images):

- Each [face](MDL-MDX-File-Format#face-structure) colored by [material](MDL-MDX-File-Format#trimesh-header)
- Walkable: Light gray
- Non-walkable: Dark gray
- Colorized: [material](MDL-MDX-File-Format#trimesh-header)-specific colors (if enabled)

### Hook Editing (Renderer/UI)

- Hooks rendered on the [walkmesh](BWM-File-Format) for placed rooms and cursor preview.
- Context menu actions: Add Hook Here, Select Hook, Delete Hook, Duplicate Hook.
- Hooks [ARE](GFF-File-Format#are-area) draggable once selected (behavior mirrors warp-point drag).
- Delete/Duplicate hotkeys act on the selected hook if one is selected; otherwise they act on selected rooms.
- Editing hooks on a room that shares a component clones the component for that room so other rooms stay unchanged.

### Snapping System

**Grid Snap**:

- Snaps positions to grid lines
- Grid size configurable

**Hook Snap**:

- Finds closest hook pair within threshold
- Calculates snap position (aligns hooks)
- Soft snapping: Disconnects if dragged away (threshold scales with zoom, intentionally easy to break free)

**Snap Calculation**:

```python
# For hook A on room1 and hook B on room2:
# Position room1 so hook A aligns with hook B's world position
snapped_pos = hook_b_world - hook_a_local
```

## Undo/Redo System

Uses Qt's `QUndoStack` for command pattern.

**Location**: `Tools/HolocronToolset/src/toolset/gui/windows/indoor_builder.py`

### Command Classes

- `AddRoomCommand`: Add room to map
- `DeleteRoomsCommand`: Remove rooms
- `MoveRoomsCommand`: Move rooms
- `RotateRoomsCommand`: Rotate rooms
- `FlipRoomsCommand`: Flip rooms
- `DuplicateRoomsCommand`: Duplicate rooms
- `MoveWarpCommand`: Move warp point
- `PaintWalkmeshCommand`: Paint [walkmesh](BWM-File-Format) [materials](MDL-MDX-File-Format#trimesh-header)
- `ResetWalkmeshCommand`: Reset [walkmesh](BWM-File-Format) overrides

### Command Pattern

Each command implements:

- `undo()`: Revert changes
- `redo()`: Apply changes
- Stores old/new states

## [walkmesh](BWM-File-Format) Painting

Allows editing surface [materials](MDL-MDX-File-Format#trimesh-header) on room [walkmeshes](BWM-File-Format).

### Input

- Painting requires **Shift + Left-click** to avoid conflicting with selection/dragging in the editor.

### Painting Process

1. **Begin Stroke**: `_begin_paint_stroke()`
   - Records original [materials](MDL-MDX-File-Format#trimesh-header)
   - Clears stroke data

2. **Apply Paint**: `_apply_paint_at_world()`
   - Picks [face](MDL-MDX-File-Format#face-structure) under cursor
   - Creates [walkmesh](BWM-File-Format) override if needed
   - Changes [material](MDL-MDX-File-Format#trimesh-header)
   - Records in stroke

3. **Finish Stroke**: `_finish_paint_stroke()`
   - Creates `PaintWalkmeshCommand`
   - Pushes to undo stack

### [walkmesh](BWM-File-Format) Overrides

- `walkmesh_override: BWM | None` on `IndoorMapRoom`
- Created on first paint (deep copy of original)
- Preserved in save/load (base64 encoded)
- Can be reset to revert to original

## Hook System

Hooks [ARE](GFF-File-Format#are-area) connection points between rooms.

### Hook types

- **Component Hooks**: Defined in `KitComponent` (template)
- **Room Hooks**: Connections in `IndoorMapRoom.hooks` (instances)

### Connection Algorithm

```python
def rebuild_connections(room, all_rooms):
    for hook in room.component.hooks:
        hook_world_pos = room.hook_position(hook)
        for other_room in all_rooms:
            for other_hook in other_room.component.hooks:
                other_hook_world_pos = other_room.hook_position(other_hook)
                if distance(hook_world_pos, other_hook_world_pos) < 0.001:
                    room.hooks[hook_index] = other_room
```

### Hook Editing

Hooks can be edited per-room:

- `_ensure_room_component_unique()`: Clones component if shared
- `add_hook_at()`: Adds new hook at world position
- `delete_hook()`: Removes hook
- `duplicate_hook()`: Copies hook

## file I/O

### Save format

`.indoor` files [ARE](GFF-File-Format#are-area) JSON:

- Human-readable
- Base64-encoded [walkmesh](BWM-File-Format) overrides
- Preserves all room properties

### Embedded Components (Toolset Merge Rooms)

The Toolset Indoor Builder supports **Merge Rooms** (context menu) which creates a *synthetic* room component
that does not come from an on-disk kit. To make these rooms survive save/load, `.indoor` may include an
`embedded_components` section.

- **When present**: the loader materializes an in-memory kit with id `__embedded__` and injects the embedded
  components into it before resolving `rooms[*].kit`/`rooms[*].component`.
- **Purpose**: allow editor workflows (like merge) to create new components without requiring a kit directory.

Shape (high level):

- `embedded_components`: list of embedded component records
  - `id`: component id referenced by rooms
  - `name`: display name
  - `bwm`: base64-encoded WOK/BWM bytes
  - `mdl`: base64-encoded MDL bytes
  - `mdx`: base64-encoded MDX bytes
  - `hooks`: list of hook records (`position`, `rotation`, `edge`)

Notes:

- Embedded hooks use a default door blueprint for width/height; the room/door graph is still driven by hook proximity.
- This is intentionally **optional** and only emitted when embedded components are present.

### No embedded `.indoor` inside modules

Some tooling historically embedded a copy of the `.indoor` JSON into the built `.mod` as an ERF resource
(`resref="indoormap"`, `restype=TXT`) for fast reload/debug.

This repository intentionally **does not embed** `.indoor` JSON into modules. Roundtrip correctness must come
from reconstructing state from real game resources (LYT/MDL/MDX/WOK/etc), not from shipping cached editor data.

Implications:

- Tooling must treat module extraction as a **real extraction** step, not a "read back cached JSON" step.
- `kotorcli indoor-extract --implicit-kit --module-file <path>` requires `--module <module_root>` to specify which
  installation module (ModuleKit) to match against when extracting from a module file.

### Load Process

1. Parse JSON
2. Find kits/components by name
3. Create `IndoorMapRoom` instances
4. Load [walkmesh](BWM-File-Format) overrides (if present)
5. Rebuild connections
6. Report missing kits/components

## Performance Considerations

### Caching

- **[walkmesh](BWM-File-Format) Cache**: `_cached_walkmeshes` in renderer
- Caches transformed [walkmeshes](BWM-File-Format) per room
- Invalidated on changes

### Lazy Loading

- Module kits loaded on-demand
- Components loaded when module selected
- Preview images generated once

### Rendering Optimization

- Only repaints when dirty
- ~60 FPS target
- Efficient coordinate transforms

## Error Handling

### Missing Resources

- Missing kits: Reported in dialog
- Missing components: Skipped, reported
- Missing files: Collected, reported at end

### Build Failures

- Graceful degradation (skip missing lightmaps)
- Error messages logged
- Build continues with available resources

## Testing

### Unit Tests

- data structure serialization
- coordinate [transformations](BWM-File-Format#walkable-adjacencies)
- Connection algorithms

### Integration Tests

- Build process end-to-end
- Module conversion
- file I/O

## References

### Code Locations

- **data structures (headless)**: `Libraries/PyKotor/src/pykotor/common/indoormap.py`
- **Kit System (headless)**: `Libraries/PyKotor/src/pykotor/common/indoorkit.py`
- **Kit loader functions**: `Libraries/PyKotor/src/pykotor/tools/indoorkit.py`
- **UI**: `Tools/HolocronToolset/src/toolset/gui/windows/indoor_builder.py`
- **ModuleKit (headless)**: `Libraries/PyKotor/src/pykotor/common/modulekit.py`
- **ModuleKit preview (Toolset Qt)**: `Tools/HolocronToolset/src/toolset/data/indoorkit/qt_preview.py`

### Related Documentation

- [LYT File Format](LYT-File-Format.md)
- [BWM File Format](BWM-File-Format.md)
- [GFF File Format](GFF-File-Format.md)
- [ERF File Format](ERF-File-Format.md)
